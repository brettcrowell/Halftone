/*! Halftone 28-01-2015 */
!function(a){"use strict";var b=function(){return!0};b.VERSION="0.0.0",a.Halftone=b,b.Options={viewportId:"viewport",svgId:"display",sourceCanvasId:"imgSource",svgNamespace:"http://www.w3.org/2000/svg",testImage:"./img/test-image.jpg",quality:200,pixelSize:10,aspectRatio:16/9,invert:!1,colorMultiplier:1,colorBase:16,stagger:!0,maxPctRgbDifference:.02,maxDeltaE:2,frameRate:10,backgroundColor:"#eee",webcam:{video:!0,audio:!1,width:320,height:240}},b.Util={rgbToHex:function(a){var b=a[0],c=a[1],d=a[2];if(b>255||c>255||d>255)throw"Invalid color component";var e="000000"+(b<<16|c<<8|d).toString(16);return"#"+e.substr(-6)},hexToDecimal:function(a){return parseInt(a.substr(1),16)},hexToRgb:function(a){return a=a.substr(1),{r:parseInt(a[0]+a[0],16),g:parseInt(a[1]+a[1],16),b:parseInt(a[2]+a[2],16)}},brightenHexColor:function(a,c){var d=this.hexToRgb(a),e=Math.min(d.r*c,255),f=Math.min(d.g*c,255),g=Math.min(d.b*c,255);return a=("000000"+b.Util.rgbToHex([e,f,g]).substr(1)).slice(-6),"#"+a[0]+a[2]+a[4]},hexToHsv:function(a){var b=parseInt(a[1]+a[1],16),c=parseInt(a[2]+a[2],16),d=parseInt(a[3]+a[3],16);return this.rgbToHsv(b,c,d)},hsvToHex:function(a,b,c){var d=this.hsvToRgb(a,b,c),e=("000000"+this.rgbToHex(d).substr(1)).slice(-6);return"#"+e[0]+e[2]+e[4]},getRasterWidth:function(a,b){var c=this.baseToRgb(a,b),d=this.rgbToHsv(c);return d[2]},rgbToGrayscale:function(a){var b=.3*a[0]+.59*a[1]+.11*a[2];return[b,b,b]},rgbToHsv:function(a){var b,c,d=a[0]/255,e=a[1]/255,f=a[2]/255,g=Math.max(d,e,f),h=Math.min(d,e,f),i=g,j=g-h;if(c=0===g?0:j/g,g==h)b=0;else{switch(g){case d:b=(e-f)/j+(f>e?6:0);break;case e:b=(f-d)/j+2;break;case f:b=(d-e)/j+4}b/=6}return[b,c,i]},hsvToRgb:function(a){var b,c,d,e=a[0],f=a[1],g=a[2],h=Math.floor(6*e),i=6*e-h,j=g*(1-f),k=g*(1-i*f),l=g*(1-(1-i)*f);switch(h%6){case 0:b=g,c=l,d=j;break;case 1:b=k,c=g,d=j;break;case 2:b=j,c=g,d=l;break;case 3:b=j,c=k,d=g;break;case 4:b=l,c=j,d=g;break;case 5:b=g,c=j,d=k}return[255*b,255*c,255*d]},rgbToBase:function(a,b){var c=b-1,d=Math.round(a[0]/255*c).toString(b),e=Math.round(a[1]/255*c).toString(b),f=Math.round(a[2]/255*c).toString(b);return d+e+f},baseToRgb:function(a,b){var c=b-1,d=Math.round(parseInt(a[0],b)/c*255),e=Math.round(parseInt(a[1],b)/c*255),f=Math.round(parseInt(a[2],b)/c*255);return[d,e,f]},brightenRgb:function(a,b){if(a){var c=Math.min(a[0]*b,255),d=Math.min(a[1]*b,255),e=Math.min(a[2]*b,255);return[c,d,e]}return[0,0,0]},getRgbSimilarity:function(a,b){var c=this.rgbToGrayscale(a),d=this.rgbToGrayscale(b),e=Math.max(c,d),f=Math.min(c,d);return(e-f)/e},getCIE76:function(a,b){var c=colorConvert.rgb2lab(a),d=colorConvert.rgb2lab(b),e=Math.max(d[0],c[0])-Math.min(d[0],c[0]),f=Math.max(d[1],c[1])-Math.min(d[1],c[1]),g=Math.max(d[2],c[2])-Math.min(d[2],c[2]),h=Math.pow(e,2),i=Math.pow(f,2),j=Math.pow(g,2),k=Math.sqrt(Math.max(h+i-j,0));return k},average:function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b/a.length},hasGetUserMedia:function(){return!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)}},b.CachedCanvasRenderer=function(){var a=b.Options.colorBase,c=Math.pow(a,3);this.cache=new Array(c),this.element=document.createElement("canvas"),this.context=this.element.getContext("2d"),this.element.setAttribute("class","renderer"),this.pixelSize=b.Options.pixelSize;var d=this.pixelSize%2;this.pixelSize+=d;var e=b.Options.quality,f=b.Options.aspectRatio;this.element.width=e*this.pixelSize,this.element.height=this.element.width*(1/f)},b.CachedCanvasRenderer.prototype={getElement:function(){return this.element},generateCircle:function(a,c){var d=document.createElement("canvas"),e=d.getContext("2d");d.width=d.height=c;var f=b.Options.colorBase,g=b.Util.baseToRgb(a,f),h="rgb("+g[0]+","+g[1]+","+g[2]+")",i=b.Util.getRasterWidth(a,f);b.Options.invert&&(i=1-i);var j=i*(c/2),k=Math.floor(c/2),l=k;return e.beginPath(),e.fillStyle=b.Util.rgbToHex(b.Util.brightenRgb(g,.5)),e.fillRect(0,0,c,c),e.arc(k,l,j+1,0,2*Math.PI,!1),e.fillStyle=h,e.fill(),e.closePath(),d},render:function(a){var c=a.matrix,d=a.metadata.cols,e=this.pixelSize,f=e/2;e+=e%2;for(var g in c){var h=c[g],i=this.context,j=this.cache,k=parseInt(g,b.Options.colorBase),l=j[k];l||(l=this.cache[k]=this.generateCircle(g,e));for(var m,n,o,p=-1,q=0;q<h.length;q++){var r=h[q];0===r&&(r=++p),p=r,m=Math.floor(r/d),n=r%d,m%2===0&&(o=f);var s=n*e+o,t=m*e;i.drawImage(l,0,0,e,e,s,t,e,e),o=0}}}},b.Compressor=function(){},b.Compressor.prototype={getDifferenceMatrix:function(a,c){for(var d={},e=0,f=b.Options.colorMultiplier,g=-1,h="#000",i=0;i<c.matrix.length;i++)for(var j=c.matrix[i],k=0;k<j.length;k++){var l=b.Util.brightenRgb(j[k],f);if(a&&a.matrix&&a.matrix[i]&&a.matrix[i][k]){var m=b.Util.brightenRgb(a.matrix[i][k],f);if(b.Util.getCIE76(m,l)<b.Options.maxDeltaE){e++;continue}}var n=b.Util.rgbToBase(l,b.Options.colorBase);d[n]||(d[n]=[]),n===h?d[h].push(0):(d[n].push(e),g=l,h=n),e++}return{metadata:c.metadata,matrix:d}}},b.FileSource=function(a){this.width=b.Options.webcam.width,this.height=b.Options.webcam.height,this.video=document.createElement("video"),this.video.autoplay=!0;var c=document.createElement("source");c.type="video/mp4",c.src=a,this.video.appendChild(c),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=this.width,this.canvas.height=this.height},b.FileSource.prototype={errorCallback:function(a){alert("Reeeejected!",a)},getFrame:function(){return this.context.drawImage(this.video,0,0,this.width,this.height),this.context.getImageData(0,0,this.width,this.height).data}},b.ImageSource=function(a){this.width=b.Options.webcam.width,this.height=b.Options.webcam.height,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=this.width,this.canvas.height=this.height,this.image=new Image,this.image.onload=function(){this.context.drawImage(this.image,0,0)}.bind(this),this.image.src=a},b.ImageSource.prototype={getFrame:function(){return this.context.getImageData(0,0,this.width,this.height).data}},b.RasterFrameEncoder=function(){this.lastEncodedFrame=null},b.RasterFrameEncoder.prototype={_getRgbAtPoint:function(a,b,c,d){var e=4*(b*c+a);return{r:d[e],g:d[e+1],b:d[e+2]}},getRgbAtPoint:function(a,b,c,d,e){var f=Math.round(c/2),g=Math.round(c/4),h=a+f,i=b+f,j=[this._getRgbAtPoint(h,i,d,e),this._getRgbAtPoint(h-g,i,d,e),this._getRgbAtPoint(h,i-g,d,e),this._getRgbAtPoint(h+g,i,d,e),this._getRgbAtPoint(h,i+g,d,e)],k=[(j[0].r+j[1].r+j[2].r+j[3].r+j[4].r)/5,(j[0].g+j[1].g+j[2].g+j[3].g+j[4].g)/5,(j[0].b+j[1].b+j[2].b+j[3].b+j[4].b)/5];return[k[0],k[1],k[2]]},encodeFrame:function(a,c){for(var d=b.Options.webcam.width,e=b.Options.webcam.height,f=b.Options.quality,g=f/d*e,h=d/f,i=h/2,j=[],k=0;g>k;k++){for(var l=[],m=k%2===0?h:i,n=0;f>n;n++){var o=Math.round(n*h+m),p=Math.round(k*h+i),q=this.getRgbAtPoint(o,p,h,d,a);l.push(q)}j.push(l)}return this.lastEncodedFrame=j,{metadata:{rows:g,cols:f,stagger:c},matrix:j}}},b.WebcamSource=function(){this.width=b.Options.webcam.width,this.height=b.Options.webcam.height,this.video=document.createElement("video"),document.body.appendChild(this.video),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=this.width,this.canvas.height=this.height,this.localMediaStream=null,b.Util.hasGetUserMedia()||alert("getUserMedia() is not supported in your browser"),getUserMedia(b.Options.webcam,this.startVideo.bind(this),this.errorCallback,this.video)},b.WebcamSource.prototype={errorCallback:function(a){alert("Reeeejected!",a)},startVideo:function(a){this.localMediaStream=a,this.video.autoplay=!0,this.video.src=window.URL.createObjectURL(this.localMediaStream),this.video.onloadedmetadata=function(a){console.log(a)}},getFrame:function(){return this.context.drawImage(this.video,0,0,this.width,this.height),this.context.getImageData(0,0,this.width,this.height).data}}}(this);