/*! Halftone 26-01-2015 */
!function(a){"use strict";var b=function(){return!0};b.VERSION="0.0.0",a.Halftone=b,b.Options={viewportId:"viewport",svgId:"display",sourceCanvasId:"imgSource",svgNamespace:"http://www.w3.org/2000/svg",testImage:"./img/test-image.jpg",quality:200,pixelSize:10,aspectRatio:4/3,colorMultiplier:1.5,colorBase:10,stagger:!0,maxPctRgbDifference:.02,frameRate:7,backgroundColor:"#eee",webcam:{video:!0,audio:!1,width:1280,height:720}},b.Util={rgbToHex:function(a,b,c){if(a>255||b>255||c>255)throw"Invalid color component";return(a<<16|b<<8|c).toString(16)},hexToDecimal:_.memoize(function(a){return parseInt(a.substr(1),16)}),hexToRgb:_.memoize(function(a){return a=a.substr(1),{r:parseInt(a[0]+a[0],16),g:parseInt(a[1]+a[1],16),b:parseInt(a[2]+a[2],16)}}),brightenHexColor:_.memoize(function(a,c){var d=this.hexToRgb(a),e=Math.min(d.r*c,255),f=Math.min(d.g*c,255),g=Math.min(d.b*c,255);return a=("000000"+b.Util.rgbToHex(e,f,g)).slice(-6),"#"+a[0]+a[2]+a[4]}),hexToHsv:_.memoize(function(a){var b=parseInt(a[1]+a[1],16),c=parseInt(a[2]+a[2],16),d=parseInt(a[3]+a[3],16);return this.rgbToHsv(b,c,d)}),hsvToHex:function(a,b,c){var d=this.hsvToRgb(a,b,c),e=("000000"+this.rgbToHex(d[0],d[1],d[2])).slice(-6);return"#"+e[0]+e[2]+e[4]},getRasterWidth:function(a,b){var c=this.baseToRgb(a,b),d=this.rgbToHsv(c);return d[2]},rgbToGrayscale:function(a){return.3*a[0]+.59*a[1]+.11*a[2]},rgbToHsv:function(a){var b,c,d=a[0]/255,e=a[1]/255,f=a[2]/255,g=Math.max(d,e,f),h=Math.min(d,e,f),i=g,j=g-h;if(c=0===g?0:j/g,g==h)b=0;else{switch(g){case d:b=(e-f)/j+(f>e?6:0);break;case e:b=(f-d)/j+2;break;case f:b=(d-e)/j+4}b/=6}return[b,c,i]},hsvToRgb:function(a){var b,c,d,e=a[0],f=a[1],g=a[2],h=Math.floor(6*e),i=6*e-h,j=g*(1-f),k=g*(1-i*f),l=g*(1-(1-i)*f);switch(h%6){case 0:b=g,c=l,d=j;break;case 1:b=k,c=g,d=j;break;case 2:b=j,c=g,d=l;break;case 3:b=j,c=k,d=g;break;case 4:b=l,c=j,d=g;break;case 5:b=g,c=j,d=k}return[255*b,255*c,255*d]},rgbToBase:function(a,b){var c=b-1,d=Math.round(a[0]/255*c).toString(b),e=Math.round(a[1]/255*c).toString(b),f=Math.round(a[2]/255*c).toString(b);return d+e+f},baseToRgb:function(a,b){var c=b-1,d=Math.round(parseInt(a[0],b)/c*255),e=Math.round(parseInt(a[1],b)/c*255),f=Math.round(parseInt(a[2],b)/c*255);return[d,e,f]},brightenRgb:function(a,b){if(a){var c=Math.min(a[0]*b,255),d=Math.min(a[1]*b,255),e=Math.min(a[2]*b,255);return[c,d,e]}return[0,0,0]},getRgbSimilarity:function(a,b){var c=this.rgbToGrayscale(a),d=this.rgbToGrayscale(b),e=Math.max(c,d),f=Math.min(c,d);return(e-f)/e},average:function(a){var b=_.reduce(a,function(a,b){return a+b});return b/a.length},hasGetUserMedia:function(){return!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)}},b.CachedCanvasRenderer=function(){var a=b.Options.colorBase,c=Math.pow(a,3);this.cache=new Array(c),this.element=document.createElement("canvas"),this.context=this.element.getContext("2d"),this.element.setAttribute("class","renderer"),this.pixelSize=b.Options.pixelSize;var d=this.pixelSize%2;this.pixelSize+=d;var e=b.Options.quality,f=b.Options.aspectRatio;this.element.width=e*this.pixelSize,this.element.height=this.element.width*(1/f)},b.CachedCanvasRenderer.prototype={getElement:function(){return this.element},generateCircle:function(a,c){var d=document.createElement("canvas"),e=d.getContext("2d");d.width=d.height=c;var f=b.Options.colorBase,g=b.Util.baseToRgb(a,f),h="rgb("+g[0]+","+g[1]+","+g[2]+")",i=b.Util.getRasterWidth(a,f)*(c/2),j=Math.floor(c/2),k=j;return e.beginPath(),e.fillRect(0,0,c,c),e.arc(j,k,i,0,2*Math.PI,!1),e.fillStyle=h,e.fill(),e.closePath(),d},render:function(a){var c=a.matrix,d=a.metadata.cols,e=this.pixelSize,f=e/2;e+=e%2;for(var g in c){var h=c[g],i=this.context,j=this.cache,k=parseInt(g,b.Options.colorBase),l=j[k];l||(l=this.cache[k]=this.generateCircle(g,e));for(var m,n,o,p=0;p<h.length;p++){var q=h[p];m=Math.floor(q/d),n=q%d,m%2===0&&(o=f);var r=n*e+o,s=m*e;i.drawImage(l,0,0,e,e,r,s,e,e),o=0}}}},b.Compressor=function(){},b.Compressor.prototype={getDifferenceMatrix:function(a,c){for(var d={},e=0,f=b.Options.colorMultiplier,g=0;g<c.matrix.length;g++)for(var h=c.matrix[g],i=0;i<h.length;i++){var j=b.Util.brightenRgb(a.matrix[g][i],f),k=b.Util.brightenRgb(h[i],f);if(b.Util.getRgbSimilarity(j,k)>b.Options.maxPctRgbDifference){var l=b.Util.rgbToBase(k,b.Options.colorBase);d[l]||(d[l]=[]),d[l].push(e)}e++}return{metadata:c.metadata,matrix:d}}},b.RasterFrameEncoder=function(){this.lastEncodedFrame=null},b.RasterFrameEncoder.prototype={_getRgbAtPoint:function(a,b,c,d){var e=4*(b*c+a);return{r:d[e],g:d[e+1],b:d[e+2]}},getRgbAtPoint:function(a,b,c,d,e){var f=Math.round(c/2),g=Math.round(c/4),h=a+f,i=b+f,j=[this._getRgbAtPoint(h,i,d,e),this._getRgbAtPoint(h-g,i,d,e),this._getRgbAtPoint(h,i-g,d,e),this._getRgbAtPoint(h+g,i,d,e),this._getRgbAtPoint(h,i+g,d,e)],k=[(j[0].r+j[1].r+j[2].r+j[3].r+j[4].r)/5,(j[0].g+j[1].g+j[2].g+j[3].g+j[4].g)/5,(j[0].b+j[1].b+j[2].b+j[3].b+j[4].b)/5];return[k[0],k[1],k[2]]},encodeFrame:function(a,c){for(var d=b.Options.webcam.width,e=b.Options.webcam.height,f=b.Options.quality,g=f/d*e,h=d/f,i=h/2,j=[],k=0;g>k;k++){for(var l=[],m=k%2===0?h:i,n=0;f>n;n++){var o=Math.round(n*h+m),p=Math.round(k*h+i),q=this.getRgbAtPoint(o,p,h,d,a);l.push(q)}j.push(l)}return this.lastEncodedFrame=j,{metadata:{rows:g,cols:f,stagger:c},matrix:j}}},b.WebcamSource=function(){this.width=b.Options.webcam.width,this.height=b.Options.webcam.height,this.video=document.createElement("video"),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=this.width,this.canvas.height=this.height,this.localMediaStream=null,b.Util.hasGetUserMedia()||alert("getUserMedia() is not supported in your browser"),getUserMedia(b.Options.webcam,this.startVideo.bind(this),this.errorCallback,this.video)},b.WebcamSource.prototype={errorCallback:function(a){alert("Reeeejected!",a)},startVideo:function(a){this.localMediaStream=a,this.video.autoplay=!0,this.video.src=window.URL.createObjectURL(this.localMediaStream),this.video.onloadedmetadata=function(a){console.log(a)}},getFrame:function(){return this.context.drawImage(this.video,0,0,this.width,this.height),this.context.getImageData(0,0,this.width,this.height).data}}}(this);