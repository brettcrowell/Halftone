/*! Halftone 25-01-2015 */
!function(){"use strict";Halftone.CachedCanvasRenderer=function(){var a=Halftone.Options.colorBase,b=Math.pow(a,3);this.cache=new Array(b),this.element=document.createElement("canvas"),this.context=this.element.getContext("2d"),this.element.setAttribute("class","renderer"),this.pixelSize=Halftone.Options.pixelSize,this.pixelSize+=this.pixelSize%2;var c=Halftone.Options.quality,d=Halftone.Options.aspectRatio;this.element.width=c*this.pixelSize,this.element.height=this.element.width*(1/d)},Halftone.CachedCanvasRenderer.prototype={getElement:function(){return this.element},generateCircle:function(a,b){var c=document.createElement("canvas"),d=c.getContext("2d");c.width=c.height=b;var e=Halftone.Options.colorBase,f=Halftone.Util.baseToRgb(a,e),g="rgb("+f[0]+","+f[1]+","+f[2]+")",h=Halftone.Util.getRasterWidth(a,e)*(b/2),i=yOnCanvas=Math.floor(b/2);return d.beginPath(),d.fillRect(0,0,b,b),d.arc(i,yOnCanvas,h,0,2*Math.PI,!1),d.fillStyle=g,d.fill(),d.closePath(),c},render:function(a){var b=a.matrix,c=a.metadata.cols,d=this.pixelSize,e=d/2;for(var f in b){var g=b[f],h=this.context,i=this.cache,j=parseInt(f,Halftone.Options.colorBase),k=i[j];k||(k=this.cache[j]=this.generateCircle(f,d));for(var l,m,n,o=0;o<g.length;o++){var p=g[o];l=Math.floor(p/c),m=p%c,l%2===0&&(n=e);var q=m*d+n,r=l*d;h.drawImage(k,0,0,d,d,q,r,d,d),n=0}}}},Halftone.CanvasRenderer=function(){this.element=document.createElement("canvas"),this.context=this.element.getContext("2d"),this.element.width=1280,this.element.height=960},Halftone.CanvasRenderer.prototype={getElement:function(){return this.element},render:function(a){var b,c,d=this.element,e=this.context,f=a.matrix,g=(1280/a.metadata.cols,pixelSize/2),h=0;e.clearRect(0,0,d.width,d.height);for(var i=0;i<f.length;i++){b=f[i],a.metadata.stagger&&i%2===0&&(h=g);for(var j=0;j<b.length;j++)if(c=b[j],null!==c){var k=j*pixelSize+g+h,l=i*pixelSize+g,m=Halftone.Util.getRasterWidth(c,g,a.metadata.maxLumens,a.metadata.minLumens);e.beginPath(),e.arc(k,l,m,0,6,!1),e.fillStyle=c,e.fill(),e.closePath()}h=0}}},Halftone.Compressor=function(){},Halftone.Compressor.prototype={getDifferenceMatrix:function(a,b){for(var c={},d=0,e=Halftone.Options.colorMultiplier,f=0;f<b.matrix.length;f++)for(var g=b.matrix[f],h=0;h<g.length;h++){var i=Halftone.Util.brightenRgb(a.matrix[f][h],e),j=Halftone.Util.brightenRgb(g[h],e);if(Halftone.Util.getRgbSimilarity(i,j)>Halftone.Options.maxPctRgbDifference){var k=Halftone.Util.rgbToBase(j,Halftone.Options.colorBase);c[k]||(c[k]=[]),c[k].push(d)}d++}return{metadata:b.metadata,matrix:c}}},Halftone.Options={viewportId:"viewport",svgId:"display",sourceCanvasId:"imgSource",svgNamespace:"http://www.w3.org/2000/svg",testImage:"./img/test-image.jpg",quality:150,colorMultiplier:1.75,colorBase:20,stagger:!0,maxPctRgbDifference:.04,frameRate:7,backgroundColor:"#eee",videoConstraints:{video:{mandatory:{maxWidth:320,maxHeight:240}}}},Halftone.PixiRenderer=function(){this.renderer=new PIXI.autoDetectRenderer(1280,960,null,!1,2,!1),this.stage=new PIXI.Stage(16777215),this._nodeCache=[]},Halftone.PixiRenderer.prototype={getElement:function(){return this.renderer.view},render:function(a){var b=this.stage,c=this._nodeCache,d=(1280/a.metadata.cols,pixelSize/2);_.each(a.matrix,function(e,f){c[f]||c.push([]),_.each(e,function(e,g){if(null!==e){var h=c[f][g];if(!h){var i=new PIXI.Graphics;i.beginFill(0),i.drawCircle(0,0,pixelSize),i.endFill(),h=new PIXI.Sprite(i.generateTexture()),h.anchor.x=.5,h.anchor.y=.5;var j=g*pixelSize,k=f*pixelSize;a.metadata.stagger&&f%2===0&&(j+=d),h.x=j+d,h.y=k+d,b.addChild(h),c[f].push(h)}var l=Halftone.Util.getRasterWidth(e,pixelSize,a.metadata.maxLumens,a.metadata.minLumens);h.width=h.height=l}})}),this.renderer.render(b)}},Halftone.RasterFrameEncoder=function(){this.lastEncodedFrame=null},Halftone.RasterFrameEncoder.prototype={_getRgbAtPoint:function(a,b,c,d){var e=4*(b*c+a);return{r:d[e],g:d[e+1],b:d[e+2]}},getRgbAtPoint:function(a,b,c,d,e){var f=Math.round(c/2),g=Math.round(c/4),h=a+f,i=b+f,j=[this._getRgbAtPoint(h,i,d,e),this._getRgbAtPoint(h-g,i,d,e),this._getRgbAtPoint(h,i-g,d,e),this._getRgbAtPoint(h+g,i,d,e),this._getRgbAtPoint(h,i+g,d,e)],k=[(j[0].r+j[1].r+j[2].r+j[3].r+j[4].r)/5,(j[0].g+j[1].g+j[2].g+j[3].g+j[4].g)/5,(j[0].b+j[1].b+j[2].b+j[3].b+j[4].b)/5];return[k[0],k[1],k[2]]},encodeFrame:function(a,b){for(var c=Halftone.Options.videoConstraints.video.mandatory.maxWidth,d=Halftone.Options.videoConstraints.video.mandatory.maxHeight,e=Halftone.Options.quality,f=e/c*d,g=c/e,h=g/2,i=[],j=0;f>j;j++){for(var k=[],l=j%2==0?g:h,m=0;e>m;m++){var n=Math.round(m*g+l),o=Math.round(j*g+h),p=this.getRgbAtPoint(n,o,g,c,a);k.push(p)}i.push(k)}return this.lastEncodedFrame=i,{metadata:{rows:f,cols:e,stagger:b},matrix:i}}},Halftone.SvgRenderer=function(){this.element=document.createElementNS(Halftone.Options.svgNamespace,"svg"),this._nodeCache=[]},Halftone.SvgRenderer.prototype={getElement:function(){return this.element},render:function(a){var b=(1280/a.metadata.cols,pixelSize/2),c=this._nodeCache,d=this.element;_.each(a.matrix,function(e,f){c[f]||c.push([]),_.each(e,function(e,g){if(null!==e){var h=c[f][g];if(h)var i=c[f][g];else{var i=document.createElementNS(Halftone.Options.svgNamespace,"circle"),j=g*pixelSize+b,k=f*pixelSize+b;a.metadata.stagger&&f%2===0&&(j+=b),i.setAttributeNS(null,"cx",j),i.setAttributeNS(null,"cy",k),d.appendChild(i),c[f].push(i)}i.setAttributeNS(null,"fill",e);var l=Halftone.Util.getRasterWidth(e,b,a.metadata.maxLumens,a.metadata.minLumens);i.setAttributeNS(null,"r",l)}})})}},Halftone.Util={rgbToHex:function(a,b,c){if(a>255||b>255||c>255)throw"Invalid color component";return(a<<16|b<<8|c).toString(16)},hexToDecimal:_.memoize(function(a){return parseInt(a.substr(1),16)}),hexToRgb:_.memoize(function(a){return a=a.substr(1),{r:parseInt(a[0]+a[0],16),g:parseInt(a[1]+a[1],16),b:parseInt(a[2]+a[2],16)}}),brightenHexColor:_.memoize(function(a,b){var c=this.hexToRgb(a),d=Math.min(c.r*b,255),e=Math.min(c.g*b,255),f=Math.min(c.b*b,255);return a=("000000"+Halftone.Util.rgbToHex(d,e,f)).slice(-6),"#"+a[0]+a[2]+a[4]}),hexToHsv:_.memoize(function(a){var b=parseInt(a[1]+a[1],16),c=parseInt(a[2]+a[2],16),d=parseInt(a[3]+a[3],16);return this.rgbToHsv(b,c,d)}),hsvToHex:function(a,b,c){var d=this.hsvToRgb(a,b,c),e=("000000"+this.rgbToHex(d[0],d[1],d[2])).slice(-6);return"#"+e[0]+e[2]+e[4]},getRasterWidth:function(a,b){var c=this.baseToRgb(a,b),d=this.rgbToHsv(c);return d[2]},rgbToGrayscale:function(a){return.3*a[0]+.59*a[1]+.11*a[2]},rgbToHsv:function(a){var b,c,d=a[0]/255,e=a[1]/255,f=a[2]/255,g=Math.max(d,e,f),h=Math.min(d,e,f),i=g,j=g-h;if(c=0==g?0:j/g,g==h)b=0;else{switch(g){case d:b=(e-f)/j+(f>e?6:0);break;case e:b=(f-d)/j+2;break;case f:b=(d-e)/j+4}b/=6}return[b,c,i]},hsvToRgb:function(a){var b,c,d,e=a[0],f=a[1],g=a[2],h=Math.floor(6*e),i=6*e-h,j=g*(1-f),k=g*(1-i*f),l=g*(1-(1-i)*f);switch(h%6){case 0:b=g,c=l,d=j;break;case 1:b=k,c=g,d=j;break;case 2:b=j,c=g,d=l;break;case 3:b=j,c=k,d=g;break;case 4:b=l,c=j,d=g;break;case 5:b=g,c=j,d=k}return[255*b,255*c,255*d]},rgbToBase:function(a,b){var c=b-1,d=Math.round(a[0]/255*c).toString(b),e=Math.round(a[1]/255*c).toString(b),f=Math.round(a[2]/255*c).toString(b);return d+e+f},baseToRgb:function(a,b){var c=b-1,d=Math.round(parseInt(a[0],b)/c*255),e=Math.round(parseInt(a[1],b)/c*255),f=Math.round(parseInt(a[2],b)/c*255);return[d,e,f]},brightenRgb:function(a,b){var c=Math.min(a[0]*b,255),d=Math.min(a[1]*b,255),e=Math.min(a[2]*b,255);return[c,d,e]},getRgbSimilarity:function(a,b){var c=this.rgbToGrayscale(a),d=this.rgbToGrayscale(b),e=Math.max(c,d),f=Math.min(c,d);return(e-f)/e},average:function(a){var b=_.reduce(a,function(a,b){return a+b});return b/a.length},hasGetUserMedia:function(){return!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)}},Halftone.WebcamSource=function(){this.width=Halftone.Options.videoConstraints.video.mandatory.maxWidth,this.height=Halftone.Options.videoConstraints.video.mandatory.maxHeight,this.video=document.createElement("video"),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=this.width,this.canvas.height=this.height,this.localMediaStream=null,Halftone.Util.hasGetUserMedia()||alert("getUserMedia() is not supported in your browser"),navigator.webkitGetUserMedia(Halftone.Options.videoConstraints,this.startVideo.bind(this),this.errorCallback)},Halftone.WebcamSource.prototype={errorCallback:function(a){alert("Reeeejected!",a)},startVideo:function(a){this.localMediaStream=a,this.video.autoplay=!0,this.video.src=window.URL.createObjectURL(this.localMediaStream),this.video.onloadedmetadata=function(){}},getFrame:function(){return this.context.drawImage(this.video,0,0,this.width,this.height),this.context.getImageData(0,0,this.width,this.height).data}}}(this);var Halftone=function(){return!0};Halftone.VERSION="0.0.0",root.Halftone=Halftone;